# lib目录结构与功能说明

本文档提供了项目lib目录的详细说明，包括各个子目录和文件的功能、用途和相互关系。

## 目录结构

```
lib/
├── auth/                  # 认证相关功能
│   ├── middleware.ts      # 认证中间件
│   └── session.ts         # 会话管理
├── db/                    # 数据库相关功能
│   ├── activity.ts        # 活动日志记录
│   ├── drizzle.ts         # Drizzle ORM配置
│   ├── migrations/        # 数据库迁移文件
│   ├── queries.ts         # 数据库查询函数
│   ├── schema.ts          # 数据库模式定义
│   ├── seed.ts            # 数据库种子数据
│   └── setup.ts           # 项目环境设置脚本
├── payments/              # 支付相关功能
│   ├── actions.ts         # 支付服务器操作
│   └── stripe.ts          # Stripe集成
├── constants.ts           # 全局常量
└── utils.ts               # 通用工具函数
```

## 核心模块说明

### 1. 认证模块 (auth/)

认证模块负责用户身份验证、会话管理和权限控制。

#### middleware.ts
- 提供表单操作的验证中间件
- 支持数据验证、用户认证和团队关联
- 使用Zod进行数据验证

#### session.ts
- 管理用户会话
- 提供密码哈希和验证功能
- 使用JWT进行会话令牌的签发和验证

### 2. 数据库模块 (db/)

数据库模块负责数据库连接、模式定义、查询和迁移。

#### activity.ts
- 提供活动日志记录功能
- 跟踪用户操作，用于审计和分析

#### drizzle.ts
- 配置Drizzle ORM
- 建立与PostgreSQL数据库的连接

#### queries.ts
- 提供各种数据库查询函数
- 包括用户、团队、活动日志等查询
- 支持分页、筛选和搜索

#### schema.ts
- 定义数据库表结构
- 定义表之间的关系
- 定义TypeScript类型

#### seed.ts
- 初始化数据库
- 创建初始用户、团队和Stripe产品

#### setup.ts
- 项目环境设置脚本
- 配置PostgreSQL、Stripe和认证密钥
- 生成.env文件

### 3. 支付模块 (payments/)

支付模块负责与Stripe集成，处理订阅和支付。

#### actions.ts
- 提供支付相关的服务器操作
- 包括结账和客户门户功能

#### stripe.ts
- Stripe API集成
- 处理结账会话、客户门户和订阅管理
- 提供产品和价格查询功能

### 4. 其他文件

#### constants.ts
- 定义全局常量
- 包括网站信息、社交媒体链接、导航链接等

#### utils.ts
- 提供通用工具函数
- 包括CSS类名合并工具

## 数据模型

项目使用以下主要数据模型：

1. **用户 (users)**
   - 存储用户基本信息
   - 包括名称、邮箱、密码哈希等

2. **团队 (teams)**
   - 存储团队信息
   - 包括订阅和计划相关数据

3. **团队成员 (teamMembers)**
   - 存储用户与团队的关联关系

4. **活动日志 (activityLogs)**
   - 记录系统中的用户活动
   - 用于审计和跟踪

5. **邀请 (invitations)**
   - 存储团队成员邀请信息

6. **订阅计划 (plans)**
   - 存储可用的订阅计划信息

7. **API密钥 (apiKeys)**
   - 存储用户创建的API访问密钥

8. **API使用记录 (apiUsage)**
   - 跟踪API的使用情况

## 认证流程

1. 用户登录时，验证凭据并创建JWT会话令牌
2. 会话令牌存储在cookie中
3. 后续请求通过验证cookie中的会话令牌来认证用户
4. 会话令牌包含用户ID和过期时间

## 支付流程

1. 用户选择订阅计划，触发结账操作
2. 创建Stripe结账会话并重定向用户
3. 用户完成支付后，Stripe回调处理订阅信息
4. 用户可以通过客户门户管理订阅

## 数据库查询

项目使用Drizzle ORM进行数据库操作，主要查询包括：

1. 用户查询：获取当前用户、用户团队等
2. 团队查询：获取团队信息、团队成员等
3. 活动日志查询：支持分页、筛选和搜索
4. 订阅查询：获取计划信息、更新订阅状态等

## 环境设置

项目使用setup.ts脚本进行环境设置，包括：

1. 检查Stripe CLI安装和认证
2. 设置PostgreSQL数据库（本地Docker或远程）
3. 获取Stripe密钥和创建webhook
4. 生成认证密钥
5. 创建.env文件
